---
title: "NYC School Perceptions according to parents "
output: html_notebook
---

Let us first import the files with which we will be working in R.

The files can be found [here](https://data.cityofnewyork.us/Education/2011-NYC-School-Survey/mnz3-dyi8) and [here](https://data.world/dq/nyc-schools-data/workspace/file?filename=combined.csv)

We will import the files using readr package and using read_csv and read_tsv functions.
```{r}
install.packages('readr')
install.packages('ggplot2')
install.packages('dplyr')
install.packages('tidyr')
install.packages('purrr')
install.packages('stringr')

library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)
library(stringr)
```

The reason why we have installed dplyr, tidyr and ggplot2 packages alongwith readr is because we will be using them throughout our project.

Reading the files
```{r}
combined <- read_csv('combined.csv')
dist <- read_tsv('masterfile11_d75_final.txt')
gened <- read_tsv('masterfile11_gened_final.txt')
```

From the data, we can see that DBN column is common in all the datasets. We can use this column to combine our datasets using R joining methods. That's why, we will include this column in any dataset we create for analyzing by 'split-apply-combine'.

sch_type tells us if the school is elementary, middle or high. Since we will be working only on high schools, we will keep this column.

As we have seen in the previous dataset, location plays an important part in the student performance. It might also play an important part in the parents and teacher's perception of school. That's why, we will be keeping this column too.

Enrollment size is a important metric as it has a direct effect on the student education. We will be keeping this column.

Like location, borough column is important and hence retained.

We can see that we have been provided with very granular data for each response as well as the combined scores of parents, teachers and students. Right now, to simplify the dataset, we will only use the combined scores for our analysis to see if we can find any pattern(s).

```{r}
gened_select <- gened %>% select(dbn: aca_tot_11) %>% filter(schooltype == 'High School')

dist_select <- dist %>% select(dbn: aca_tot_11)
```

Using the above code, we have filtered out only the high schools and total score columns from the general education and district 75 dataset.

Let us now join the two dataframes we have created. Our final goal is to combine all these dataframes into one dataframe for analysis. This is step 1 of 2 of that goal.

```{r}
gen_dist <- (bind_rows(gened_select, dist_select))
gen_dist <- gen_dist %>% rename(DBN = dbn)
```

We renamed the 'dbn' column from gen_dist to 'DBN' because we want to match our key with the other dataset.

Since key is now same, now we can combine gen_dist and combined dataframe in one final dataframe. This is step 2 of 2.

```{r}
final_set <- combined %>% left_join(gen_dist, by = 'DBN')
```

Because we want to check the relationships between the 'combined' dataframe and the new 'gen_dist' dataframe, we use left_join() method. This will allow us to find relation if any, between the demographics & academic scores and parent, teacher & students' perception for NYC schools.

In order to find relations, we will create a correlation matrix for our data.
But, we have missing values in many of the rows and we need to first take care of them.

```{r}
final_drop <- final_set %>% drop_na(`Num of SAT Test Takers`)
```

Since we want to find relation between academics and other factors, we have dropped all the values of NA for SAT test takers.

Let us now create a correlation matrix.

```{r}
cor_mat <- final_drop %>% select(avg_sat_score, saf_p_11:aca_tot_11) %>% 
  cor(use = 'pairwise.complete.obs')

tibcor <- as_tibble(cor_mat, rownames = 'variable')
```

Now we have a correlation matrix between avg SAT scores and all the responses from parents, teachers & students.
For easier use, we have also converted it into a tibble using as_tibble() from dplyr package.

Let us now check for any interesting relationships.

```{r}
avg_score_cor <- tibcor %>% select(variable, avg_sat_score) %>% 
  filter (avg_sat_score > 0.25 | avg_sat_score < - 0.25) #avg_sat_score and  others
```

From the correlation matrix, 5 variable have correlation value more than 0.25 and less than -0.25 indicating some sort of correlation. Let us visualize the 5 variables using scatter plot to get a better understanding.

We will use ggplot2 for visualizations. We have already loaded it.

```{r}
create_plots <- function(x, y) {
  ggplot(data = final_drop) + 
    aes_string(x = x, y = y) + 
    geom_point(alpha = 0.3) +
    theme(panel.background = element_rect(fill = 'white'))+
  geom_smooth(method = lm)
}

y_var <- 'avg_sat_score'
x_var <- avg_score_cor$variable[2:5]

map2(x_var, y_var, create_plots)

```

# Academic Scores vs. Perceptions
From the above graphs, we can see that their is weak relationship between the perceptions and academic scores.
Next, let us analyze if students, teachers and parents have same perceptions of NYC schools based on their survey answers.

In order to analyze that, we will first have to reshape the dataframe in another format.

```{r}
gather_final <- final_drop %>% gather(key = 'survey_q', value = score, saf_p_11:aca_tot_11) %>%
  mutate(response_type = str_sub(survey_q, 4,6)) %>%
  mutate(question = str_sub(survey_q, 1,3))
```

Let's now change the values of response_type column to parent/teacher/student.

```{r}
gather_final <- gather_final %>% mutate(response_type = if_else(response_type == '_p_', 'Parent',
                                                if_else(response_type == '_s_', 'Student',
                                                        if_else(response_type == 
                                                                  '_t_', 'Teacher',
                                                                if_else(response_type == '_to', 'Total','NA')))))
```

Let us now visualize the data to answer our questions. We will create boxplots for the same.

```{r}
gather_final %>% filter(response_type != 'Total') %>%
  ggplot() + aes(x = question, y = score, fill = response_type) +
    theme(panel.background = element_rect(fill= 'white')) +
    geom_boxplot()  
```

aca: academic expectations
com: communication
eng: engagement
saf: safety and respect

# Insights from the graph

We can see that for students, teachers and parents have different perceptions.

## Safety and respect
For the saf(Safety and Respect) question, it can be seen that parent ratings are higher than those of teachers and students.
This could be because parents do not go to school as frequently as students and teachers. Therefore, their perception of safety and respect is based only on the few interactions when in reality, the schools are not nearly as safe as they should be.

## Engagement
The scores of students and teachers vary significantly for this metric. While teachers have rated generously, the student ratings are not so generous. This highlights the gap between student and teacher perception for engagement.
Even the variablity of student ratings for engagement is less indicating that a good chunk of students feel the same way.

## Communication
The difference between student and teacher rating is almost double in this case. This is another area (other being engagement) which needs to be focussed on as perceptions between them vary a lot.

## Academic expectations
While the ratings by parents and teachers are high for this question, the student ratings are quite low. The student rating variablity is also less indicating that a lot of students have low academic expectations from their schools.

## Perception of Teachers
Perception of teachers across all four sections showing more variance than that of Parents and Students. Which means teachers have low agreement between themselves and on the other end students are showing maximum agreement among themselves.

## Parent-Children Gap
Teachers have given higher rating overall which seems to be obvious. Difference between ratings of parents and students shows the lack of trust between parents and their respective wards, as they might not be taking the feedback from their wards seriously.

## Other
Also if we look at outliers on the upper side, some of the students and parents have shown disagreement with the masses. One possible explanation is, some students who might be in good books of teachers or good performers have given a higher rating. 



